<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>100 Dayz - Survival Raid</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #1a1a1a; color: white; overflow: hidden; user-select: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        canvas { background-color: #2e3b28; box-shadow: 0 0 20px rgba(0,0,0,0.8); cursor: crosshair; }
        
        /* UI ìŠ¤íƒ€ì¼ */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .hud-panel { position: absolute; background: rgba(0,0,0,0.7); padding: 10px 15px; border-radius: 8px; border: 1px solid #444; pointer-events: auto; }
        
        #top-bar { top: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; align-items: center; }
        #stats-bar { bottom: 20px; left: 20px; text-align: left; }
        #controls-info { bottom: 20px; right: 20px; font-size: 12px; color: #aaa; text-align: right; }
        
        .stat-icon { font-size: 1.2rem; margin-right: 5px; width: 25px; display: inline-block; text-align: center; }
        .bar-container { width: 120px; height: 12px; background: #444; border-radius: 6px; overflow: hidden; display: inline-block; vertical-align: middle; margin-right: 8px; }
        .bar-fill { height: 100%; transition: width 0.2s; }
        .hp-fill { background: #e53935; }
        .hunger-fill { background: #fb8c00; }
        
        #message-modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none; background: rgba(0,0,0,0.9); padding: 40px; border-radius: 10px; border: 2px solid #d32f2f; z-index: 10; pointer-events: auto; }
        button.btn-primary { background: #d32f2f; color: white; padding: 8px 16px; border-radius: 4px; font-weight: bold; border: none; cursor: pointer; transition: 0.2s; }
        button.btn-primary:hover { background: #b71c1c; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <!-- ìƒë‹¨ ì •ë³´ -->
        <div id="top-bar" class="hud-panel">
            <div>ğŸ“… <span id="day-display" class="font-bold text-xl text-yellow-400">Day 1</span></div>
            <div>â° <span id="time-display" class="font-bold">09:00</span></div>
            <div>âš ï¸ ìœ„í—˜ë„: <span id="threat-display" class="text-red-400 font-bold">1</span> Lv</div>
            <button class="btn-primary text-sm" onclick="game.travel()">ğŸšš ì§€ì—­ ì´ë™ (ì´ˆê¸°í™”)</button>
        </div>

        <!-- í•˜ë‹¨ ìŠ¤íƒ¯ -->
        <div id="stats-bar" class="hud-panel">
            <!-- ì²´ë ¥ -->
            <div class="mb-2 flex items-center">
                <span class="stat-icon">â¤ï¸</span> 
                <div class="bar-container"><div id="hp-bar" class="bar-fill hp-fill" style="width: 100%;"></div></div>
                <span id="hp-text" class="text-sm font-mono">100/100</span>
            </div>
            <!-- í—ˆê¸° (ì‹ ê·œ) -->
            <div class="mb-2 flex items-center">
                <span class="stat-icon">ğŸ–</span> 
                <div class="bar-container"><div id="hunger-bar" class="bar-fill hunger-fill" style="width: 10%; origin: left;"></div></div>
                <span id="hunger-text" class="text-sm font-mono">100/1000</span>
            </div>
            
            <div class="mt-2 text-sm">
                <div class="mb-1"><span class="stat-icon">ğŸ”«</span> <span id="ammo-text" class="text-yellow-200 font-bold">30</span>ë°œ</div>
                <div><span class="stat-icon">ğŸªµ</span> <span id="wood-text" class="text-amber-600 font-bold">0</span> (ë°”ë¦¬ì¼€ì´ë“œ: 10ê°œ í•„ìš”)</div>
            </div>
        </div>

        <!-- ì¡°ì‘ë²• -->
        <div id="controls-info" class="hud-panel">
            <p>[W,A,S,D] ì´ë™</p>
            <p>[í´ë¦­] ì‚¬ê²©</p>
            <p>[ëª¸ìœ¼ë¡œ ë‹¿ê¸°] ì•„ì´í…œ/ëª©ì¬ ìˆ˜ì§‘</p>
            <p>[B] ë°”ë¦¬ì¼€ì´ë“œ ê±´ì„¤</p>
        </div>
    </div>

    <!-- ê²Œì„ ì˜¤ë²„ / ì•Œë¦¼ì°½ -->
    <div id="message-modal">
        <h1 id="msg-title" class="text-4xl font-bold mb-4 text-red-500">GAME OVER</h1>
        <p id="msg-desc" class="mb-6 text-gray-300">ë‹¹ì‹ ì€ ì¢€ë¹„ë“¤ì—ê²Œ ì¡ì•„ë¨¹í˜”ìŠµë‹ˆë‹¤.</p>
        <button class="btn-primary w-full text-lg" onclick="location.reload()">ë‹¤ì‹œ ì‹œì‘</button>
    </div>
</div>

<script>
/**
 * 100 Dayz Game Logic
 * Updated:
 * - Fixed aiming direction (mouse follow)
 */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì •
function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// --- ê²Œì„ ì„¤ì • ---
const TILE_SIZE = 40;
const PLAYER_SPEED = 4;
const ZOMBIE_BASE_SPEED = 1.5;

// ê²Œì„ ìƒíƒœ
const game = {
    active: true,
    day: 1,
    time: 0, // 0 ~ 2400 (í•˜ë£¨ ì‚¬ì´í´)
    isNight: false,
    stayDuration: 1, // í•œ ì§€ì—­ ì²´ë¥˜ì¼
    threat: 1,
    
    // ì—”í‹°í‹°
    player: { 
        x: 0, y: 0, size: 20, 
        hp: 100, maxHp: 100, 
        hunger: 100, maxHunger: 1000, 
        ammo: 30, wood: 0, angle: 0 
    },
    bullets: [],
    zombies: [],
    walls: [], // {x, y, w, h}
    doors: [], // {x, y, w, h, hp, maxHp, active}
    resources: [], // {x, y, w, h, type, val}
    barricades: [], // {x, y, hp}
    particles: [],

    // ì‹œìŠ¤í…œ
    camera: { x: 0, y: 0 },
    
    // ì´ˆê¸°í™” ë° ì§€ì—­ ì´ë™
    initWorld: function() {
        this.walls = [];
        this.doors = [];
        this.resources = [];
        this.barricades = [];
        this.zombies = [];
        this.bullets = [];
        
        // ë§µ ìƒì„± (ê²©ì í˜•íƒœì˜ ë°© ë°°ì¹˜)
        const mapW = 2000;
        const mapH = 2000;
        
        // í”Œë ˆì´ì–´ ì¤‘ì•™ ë°°ì¹˜
        this.player.x = mapW / 2;
        this.player.y = mapH / 2;

        // ê±´ë¬¼ ìƒì„± (ëœë¤ ìœ„ì¹˜ì— 5~8ê°œ)
        const houseCount = 5 + Math.floor(Math.random() * 4);
        
        for(let i=0; i<houseCount; i++) {
            let hw = 200 + Math.random() * 300; // ë„ˆë¹„
            let hh = 200 + Math.random() * 300; // ë†’ì´
            let hx = Math.random() * (mapW - hw);
            let hy = Math.random() * (mapH - hh);
            
            this.createHouse(hx, hy, hw, hh);
        }

        // ì•¼ì™¸ ì¥ì‹
        for(let i=0; i<30; i++) {
            this.particles.push({
                x: Math.random() * mapW,
                y: Math.random() * mapH,
                size: Math.random() * 5 + 2,
                color: '#3e4f35',
                life: 99999, // ì˜êµ¬ ì§€ì†
                type: 'deco'
            });
        }
        
        // ì•ˆë‚´ ë©”ì‹œì§€
        this.showMessage(`Day ${this.day} ì‹œì‘`, "ê±´ë¬¼ ì•ˆì„ íŒŒë°í•˜ê³  ë°¤ì„ ëŒ€ë¹„í•˜ì„¸ìš”!", 2000);
    },

    createHouse: function(x, y, w, h) {
        const wallThickness = 20;
        
        // ë²½ 4ê°œ ìƒì„± (ì„ì‹œ ì €ì¥ í›„ ë¬¸ ëš«ê¸°)
        // ìœ„
        this.walls.push({x: x, y: y, w: w, h: wallThickness});
        // ì•„ë˜ (ë‚˜ì¤‘ì— ìª¼ê°œì§)
        const bottomWallY = y + h - wallThickness;
        // ì™¼ìª½
        this.walls.push({x: x, y: y, w: wallThickness, h: h});
        // ì˜¤ë¥¸ìª½
        this.walls.push({x: x + w - wallThickness, y: y, w: wallThickness, h: h});

        // ë¬¸ ìƒì„± (ì•„ë˜ìª½ ë²½ ì¤‘ì•™)
        const doorW = 80;
        const doorH = wallThickness;
        const doorX = x + w/2 - doorW/2;
        const doorY = bottomWallY;

        // ì•„ë˜ìª½ ë²½ 2ê°œë¡œ ë¶„í• 
        this.walls.push({x: x, y: bottomWallY, w: w/2 - doorW/2, h: wallThickness});
        this.walls.push({x: x + w/2 + doorW/2, y: bottomWallY, w: w/2 - doorW/2, h: wallThickness});

        // ë¬¸ ê°ì²´
        const newDoor = {
            x: doorX, y: doorY, w: doorW, h: doorH,
            hp: 100, maxHp: 100,
            active: true
        };
        this.doors.push(newDoor);

        // --- ë‚´ë¶€ ìì› ìƒì„± (ê²¹ì¹¨ ë°©ì§€) ---
        const safeArea = {
            x: x + wallThickness + 5,
            y: y + wallThickness + 5,
            w: w - (wallThickness*2) - 10,
            h: h - (wallThickness*2) - 10
        };

        const createResource = (type, color, val, width=20) => {
            let attempts = 0;
            let success = false;
            let rx, ry;

            while(attempts < 10 && !success) {
                rx = safeArea.x + Math.random() * (safeArea.w - width);
                ry = safeArea.y + Math.random() * (safeArea.h - width);
                const rect = {x: rx, y: ry, w: width, h: width};

                // ë¬¸ê³¼ì˜ ê±°ë¦¬ ì²´í¬
                const distToDoor = utils.dist(rx + width/2, ry + width/2, newDoor.x + newDoor.w/2, newDoor.y + newDoor.h/2);
                if(distToDoor < 80) { 
                    attempts++;
                    continue;
                }
                success = true;
            }

            if(success) {
                this.resources.push({
                    x: rx, y: ry, w: width, h: width,
                    type: type, val: val, color: color
                });
            }
        };

        // 1. ëª©ì¬
        for(let i=0; i<3 + Math.random()*3; i++) {
            createResource('wood', '#8D6E63', 5, 30);
        }
        // 2. íƒ„ì•½
        if(Math.random() > 0.3) {
            createResource('ammo', '#FDD835', 10 + Math.floor(Math.random()*10));
        }
        // 3. ì‹ëŸ‰
        if(Math.random() > 0.4) {
            createResource('food', '#43A047', 10);
        }
    },

    travel: function() {
        if(this.isNight) {
            this.showMessage("ì´ë™ ë¶ˆê°€!", "ë°¤ì—ëŠ” ë„ˆë¬´ ìœ„í—˜í•´ì„œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 1500);
            return;
        }
        this.stayDuration = 1;
        this.threat = 1;
        this.time = 0; // ì•„ì¹¨ìœ¼ë¡œ
        this.initWorld();
        ui.update();
    },

    spawnZombie: function() {
        const angle = Math.random() * Math.PI * 2;
        const dist = Math.max(canvas.width, canvas.height) / 2 + 100;
        const zx = this.player.x + Math.cos(angle) * dist;
        const zy = this.player.y + Math.sin(angle) * dist;

        const hp = 2 + Math.floor(this.threat * 1.5);
        const speed = ZOMBIE_BASE_SPEED + (this.threat * 0.1);

        this.zombies.push({
            x: zx, y: zy, size: 20,
            hp: hp, maxHp: hp,
            speed: speed,
            attackCd: 0,
            color: '#e53935'
        });
    },

    showMessage: function(title, desc, duration) {
        const modal = document.getElementById('message-modal');
        if(title === "GAME OVER") {
            modal.style.display = 'block';
            document.getElementById('msg-title').innerText = title;
            document.getElementById('msg-desc').innerText = desc;
        } else {
            console.log(title, desc);
        }
    }
};

// --- ì…ë ¥ ì²˜ë¦¬ ---
const input = {
    keys: {},
    mouse: { x: 0, y: 0, down: false },
    init: function() {
        window.addEventListener('keydown', e => {
            this.keys[e.key.toLowerCase()] = true;
            if(e.key.toLowerCase() === 'b') actions.buildBarricade();
        });
        window.addEventListener('keyup', e => this.keys[e.key.toLowerCase()] = false);
        window.addEventListener('mousemove', e => {
            this.mouse.x = e.clientX;
            this.mouse.y = e.clientY;
        });
        window.addEventListener('mousedown', () => {
            this.mouse.down = true;
            actions.shootOrInteract();
        });
        window.addEventListener('mouseup', () => this.mouse.down = false);
    }
};

const actions = {
    shootOrInteract: function() {
        if(!game.active) return;

        // ì‚¬ê²©ë§Œ ì²˜ë¦¬ (ìì› ìˆ˜ì§‘ì€ ìë™í™”ë¨)
        if(game.player.ammo > 0) {
            game.player.ammo--;
            // [ìˆ˜ì •ë¨] ë§ˆìš°ìŠ¤ ì¢Œí‘œ(ìŠ¤í¬ë¦°) - ì¹´ë©”ë¼ ì˜¤í”„ì…‹ = ì›”ë“œ ì¢Œí‘œ
            const mx = input.mouse.x - game.camera.x;
            const my = input.mouse.y - game.camera.y;
            const angle = Math.atan2(my - game.player.y, mx - game.player.x);
            
            game.bullets.push({
                x: game.player.x, y: game.player.y,
                vx: Math.cos(angle) * 15,
                vy: Math.sin(angle) * 15,
                life: 100
            });
            // ë°˜ë™
            game.camera.x += Math.cos(angle) * 2;
            game.camera.y += Math.sin(angle) * 2;
        } else {
            utils.createFloatText(game.player.x, game.player.y - 40, "íƒ„ì•½ ë¶€ì¡±!", "white");
        }
        ui.update();
    },

    buildBarricade: function() {
        if(game.player.wood >= 10) {
            game.player.wood -= 10;
            game.barricades.push({
                x: game.player.x - 15,
                y: game.player.y - 15,
                w: 30, h: 30,
                hp: 50, maxHp: 50
            });
            utils.createFloatText(game.player.x, game.player.y - 40, "ë°”ë¦¬ì¼€ì´ë“œ ì„¤ì¹˜", "#FFB74D");
            ui.update();
        } else {
            utils.createFloatText(game.player.x, game.player.y - 40, "ëª©ì¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤ (10ê°œ í•„ìš”)", "red");
        }
    }
};

// --- ìœ í‹¸ë¦¬í‹° ---
const utils = {
    dist: (x1, y1, x2, y2) => Math.hypot(x2-x1, y2-y1),
    rectIntersect: (r1, r2) => {
        return r1.x < r2.x + r2.w && r1.x + r1.w > r2.x &&
               r1.y < r2.y + r2.h && r1.y + r1.h > r2.y;
    },
    createParticles: (x, y, color, count) => {
        for(let i=0; i<count; i++) {
            game.particles.push({
                x: x, y: y,
                vx: (Math.random() - 0.5) * 5,
                vy: (Math.random() - 0.5) * 5,
                life: 20,
                color: color,
                size: Math.random() * 3 + 1
            });
        }
    },
    createFloatText: (x, y, text, color) => {
        game.particles.push({
            x: x, y: y, vx: 0, vy: -1, life: 60,
            text: text, color: color, type: 'text'
        });
    }
};

// --- ê²Œì„ ë£¨í”„ ---
function update() {
    if(!game.active) return;

    // 1. ì‹œê°„ íë¦„ & í—ˆê¸° ì‹œìŠ¤í…œ
    game.time += 1;
    
    // í—ˆê¸° ê°ì†Œ
    if(game.time % 300 === 0) {
        game.player.hunger = Math.max(0, game.player.hunger - 1);
        ui.update();
        if(game.player.hunger === 0) {
            utils.createFloatText(game.player.x, game.player.y - 20, "ë°°ê³ íŒŒ...", "orange");
        }
    }

    const dayLength = 3600;
    const cyclePos = game.time % dayLength;
    const nightStart = dayLength * 0.7;
    
    if(!game.isNight && cyclePos > nightStart) {
        game.isNight = true;
        utils.createFloatText(game.player.x, game.player.y - 50, "ë°¤ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!", "red");
        ui.update();
    } else if (game.isNight && cyclePos < nightStart && game.time > dayLength) {
        game.isNight = false;
        game.day++;
        game.stayDuration++;
        game.threat = game.stayDuration;
        game.time = 0;
        game.zombies = [];
        utils.createFloatText(game.player.x, game.player.y - 50, `Day ${game.day} - ìƒì¡´!`, "yellow");
        ui.update();
    }

    // 2. ì¢€ë¹„ ìŠ¤í° (ë°¤)
    if(game.isNight) {
        const spawnInterval = Math.max(20, 120 - (game.threat * 5));
        if(game.time % spawnInterval === 0) game.spawnZombie();
    }

    // 3. í”Œë ˆì´ì–´ ì´ë™
    let moveX = 0;
    let moveY = 0;
    if(input.keys['w']) moveY = -PLAYER_SPEED;
    if(input.keys['s']) moveY = PLAYER_SPEED;
    if(input.keys['a']) moveX = -PLAYER_SPEED;
    if(input.keys['d']) moveX = PLAYER_SPEED;

    game.player.x += moveX;
    let playerRect = { x: game.player.x - 10, y: game.player.y - 10, w: 20, h: 20 };
    
    // ë²½ ì¶©ëŒ
    for(let w of game.walls) {
        if(utils.rectIntersect(playerRect, w)) {
            if(moveX > 0) game.player.x = w.x - 10;
            else if(moveX < 0) game.player.x = w.x + w.w + 10;
        }
    }
    // ë¬¸ ì¶©ëŒ (ë‹«íŒ ë¬¸)
    for(let d of game.doors) {
        if(d.active && utils.rectIntersect(playerRect, d)) {
             if(moveX > 0) game.player.x = d.x - 10;
             else if(moveX < 0) game.player.x = d.x + d.w + 10;
        }
    }

    game.player.y += moveY;
    playerRect = { x: game.player.x - 10, y: game.player.y - 10, w: 20, h: 20 };
    
    for(let w of game.walls) {
        if(utils.rectIntersect(playerRect, w)) {
            if(moveY > 0) game.player.y = w.y - 10;
            else if(moveY < 0) game.player.y = w.y + w.h + 10;
        }
    }
    for(let d of game.doors) {
        if(d.active && utils.rectIntersect(playerRect, d)) {
             if(moveY > 0) game.player.y = d.y - 10;
             else if(moveY < 0) game.player.y = d.y + d.h + 10;
        }
    }

    // 4. ìì› ìë™ ìˆ˜ì§‘ (ëª¨ë“  ìì›)
    for(let i=game.resources.length-1; i>=0; i--) {
        let r = game.resources[i];
        if(utils.dist(game.player.x, game.player.y, r.x + r.w/2, r.y + r.h/2) < 30) {
            let collected = false;
            
            if(r.type === 'food') {
                if(game.player.hunger < game.player.maxHunger) {
                    game.player.hunger = Math.min(game.player.maxHunger, game.player.hunger + r.val);
                    utils.createFloatText(game.player.x, game.player.y, `+${r.val} í—ˆê¸°`, "#fb8c00");
                    collected = true;
                } else {
                    game.player.hunger = Math.min(game.player.maxHunger, game.player.hunger + r.val);
                    utils.createFloatText(game.player.x, game.player.y, `ë°°ë¶€ë¦„!`, "#fb8c00");
                    collected = true;
                }
            } else if (r.type === 'ammo') {
                game.player.ammo += r.val;
                utils.createFloatText(game.player.x, game.player.y, `+${r.val} íƒ„ì•½`, "#FDD835");
                collected = true;
            } else if (r.type === 'wood') {
                game.player.wood += r.val;
                utils.createFloatText(game.player.x, game.player.y, `+${r.val} ëª©ì¬`, "#8D6E63");
                collected = true;
            }

            if(collected) {
                game.resources.splice(i, 1);
                ui.update();
            }
        }
    }

    // 5. ì´ì•Œ
    for(let i=game.bullets.length-1; i>=0; i--) {
        let b = game.bullets[i];
        b.x += b.vx; b.y += b.vy; b.life--;
        if(b.life <= 0) { game.bullets.splice(i, 1); continue; }

        let bulletRect = { x: b.x-2, y: b.y-2, w: 4, h: 4 };
        let hit = false;

        // ë¬¸ íƒ€ê²©
        for(let d of game.doors) {
            if(d.active && utils.rectIntersect(bulletRect, d)) {
                d.hp -= 10;
                utils.createParticles(b.x, b.y, '#8D6E63', 2);
                if(d.hp <= 0) d.active = false;
                hit = true; break;
            }
        }
        
        // ì¢€ë¹„ íƒ€ê²©
        if(!hit) {
            for(let zIndex=game.zombies.length-1; zIndex>=0; zIndex--) {
                let z = game.zombies[zIndex];
                if(utils.dist(b.x, b.y, z.x, z.y) < z.size + 2) {
                    z.hp--;
                    z.x -= b.vx * 0.2; z.y -= b.vy * 0.2;
                    utils.createParticles(z.x, z.y, '#e53935', 3);
                    if(z.hp <= 0) {
                        game.zombies.splice(zIndex, 1);
                        if(Math.random() < 0.2) {
                            game.resources.push({
                                x: z.x - 10, y: z.y - 10, w: 20, h: 20,
                                type: 'ammo', val: 5, color: '#FDD835'
                            });
                        }
                    }
                    hit = true; break;
                }
            }
        }
        if(hit) game.bullets.splice(i, 1);
    }

    // 6. ì¢€ë¹„ ë¡œì§
    for(let z of game.zombies) {
        const angle = Math.atan2(game.player.y - z.y, game.player.x - z.x);
        let nextX = z.x + Math.cos(angle) * z.speed;
        let nextY = z.y + Math.sin(angle) * z.speed;
        let zRect = { x: nextX - z.size/2, y: nextY - z.size/2, w: z.size, h: z.size };

        let blocked = false;
        // ë²½/ë¬¸/ë°”ë¦¬ì¼€ì´ë“œ ì¶©ëŒ
        for(let w of game.walls) if(utils.rectIntersect(zRect, w)) { blocked = true; break; }
        if(!blocked) {
            for(let d of game.doors) {
                if(d.active && utils.rectIntersect(zRect, d)) {
                    blocked = true;
                    z.attackCd--;
                    if(z.attackCd <= 0) {
                        d.hp -= 2; utils.createParticles(d.x+d.w/2, d.y+d.h/2, '#8D6E63', 1);
                        if(d.hp<=0) d.active = false;
                        z.attackCd=30;
                    }
                }
            }
        }
        if(!blocked) {
            for(let i=game.barricades.length-1; i>=0; i--) {
                let b = game.barricades[i];
                if(utils.rectIntersect(zRect, b)) {
                    blocked = true;
                    z.attackCd--;
                    if(z.attackCd <= 0) {
                        b.hp -= 2; utils.createParticles(b.x+b.w/2, b.y+b.h/2, '#FFB74D', 1);
                        if(b.hp<=0) game.barricades.splice(i, 1);
                        z.attackCd=30;
                    }
                }
            }
        }

        if(!blocked) { z.x = nextX; z.y = nextY; }

        if(utils.dist(z.x, z.y, game.player.x, game.player.y) < z.size + 10) {
             z.attackCd--;
             if(z.attackCd <= 0) {
                 game.player.hp -= 10;
                 ui.update();
                 utils.createFloatText(game.player.x, game.player.y, "-10", "red");
                 if(game.player.hp <= 0) {
                     game.active = false;
                     game.showMessage("GAME OVER", "ë‹¹ì‹ ì€ ìƒì¡´í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                 }
                 z.attackCd = 60;
             }
        }
    }

    // íŒŒí‹°í´
    for(let i=game.particles.length-1; i>=0; i--) {
        let p = game.particles[i];
        if(p.type === 'deco') continue;
        p.x += p.vx; p.y += p.vy; p.life--;
        if(p.life <= 0) game.particles.splice(i, 1);
    }
}

function draw() {
    game.camera.x = canvas.width/2 - game.player.x;
    game.camera.y = canvas.height/2 - game.player.y;

    ctx.fillStyle = game.isNight ? '#121212' : '#5D4037';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.save();
    ctx.translate(game.camera.x, game.camera.y);

    // ë°”ë‹¥
    ctx.strokeStyle = '#ffffff11';
    ctx.beginPath();
    for(let x=-1000; x<3000; x+=100) { ctx.moveTo(x, -1000); ctx.lineTo(x, 3000); }
    for(let y=-1000; y<3000; y+=100) { ctx.moveTo(-1000, y); ctx.lineTo(3000, y); }
    ctx.stroke();

    // ì¥ì‹
    game.particles.forEach(p => {
        if(p.type === 'deco') {
            ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
        }
    });

    // ë²½
    ctx.fillStyle = '#9E9E9E';
    for(let w of game.walls) {
        ctx.fillRect(w.x, w.y, w.w, w.h);
        ctx.strokeStyle = '#616161'; ctx.strokeRect(w.x, w.y, w.w, w.h);
    }

    // ìì›
    for(let r of game.resources) {
        ctx.fillStyle = r.color;
        ctx.fillRect(r.x, r.y, r.w, r.h);
        ctx.fillStyle = 'white'; ctx.font = '10px Arial';
        let name = r.type === 'wood' ? 'ëª©ì¬' : (r.type === 'food' ? 'ì‹ëŸ‰' : 'íƒ„ì•½');
        ctx.fillText(name, r.x, r.y - 5);
        // ëª©ì¬ HPë°” ì‚­ì œë¨ (ìë™ ìˆ˜ì§‘ì´ë¯€ë¡œ)
    }

    // ë°”ë¦¬ì¼€ì´ë“œ
    ctx.fillStyle = '#FFB74D';
    for(let b of game.barricades) {
        ctx.fillRect(b.x, b.y, b.w, b.h);
        ctx.strokeStyle = '#E65100'; ctx.strokeRect(b.x, b.y, b.w, b.h);
    }

    // ë¬¸
    for(let d of game.doors) {
        if(d.active) {
            ctx.fillStyle = '#795548';
            ctx.fillRect(d.x, d.y, d.w, d.h);
            ctx.fillStyle = 'black'; ctx.fillRect(d.x, d.y - 10, d.w, 5);
            ctx.fillStyle = 'lime'; ctx.fillRect(d.x, d.y - 10, (d.hp/d.maxHp)*d.w, 5);
        }
    }

    // ì¢€ë¹„
    for(let z of game.zombies) {
        ctx.fillStyle = z.color;
        ctx.beginPath(); ctx.arc(z.x, z.y, z.size/2, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'red'; ctx.fillRect(z.x - 10, z.y - 20, 20, 4);
        ctx.fillStyle = 'lime'; ctx.fillRect(z.x - 10, z.y - 20, (z.hp/z.maxHp)*20, 4);
    }

    // í”Œë ˆì´ì–´
    ctx.fillStyle = '#42A5F5';
    ctx.beginPath(); ctx.arc(game.player.x, game.player.y, game.player.size/2, 0, Math.PI*2); ctx.fill();
    // [ìˆ˜ì •ë¨] ë§ˆìš°ìŠ¤ ì¢Œí‘œ(ìŠ¤í¬ë¦°) - ì¹´ë©”ë¼ ì˜¤í”„ì…‹ = ì›”ë“œ ì¢Œí‘œ
    const mx = input.mouse.x - game.camera.x;
    const my = input.mouse.y - game.camera.y;
    const angle = Math.atan2(my - game.player.y, mx - game.player.x);
    ctx.strokeStyle = 'white'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(game.player.x, game.player.y);
    ctx.lineTo(game.player.x + Math.cos(angle)*20, game.player.y + Math.sin(angle)*20);
    ctx.stroke();

    // ì´ì•Œ
    ctx.fillStyle = '#FFF176';
    for(let b of game.bullets) { ctx.beginPath(); ctx.arc(b.x, b.y, 2, 0, Math.PI*2); ctx.fill(); }

    // íŒŒí‹°í´ (í…ìŠ¤íŠ¸ ë“±)
    for(let p of game.particles) {
        if(p.type === 'text') {
            ctx.fillStyle = p.color; ctx.font = 'bold 14px sans-serif'; ctx.fillText(p.text, p.x, p.y);
        } else if (p.type !== 'deco') {
            ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size);
        }
    }

    if(game.isNight) {
        const grad = ctx.createRadialGradient(game.player.x, game.player.y, 100, game.player.x, game.player.y, 600);
        grad.addColorStop(0, 'rgba(0,0,0,0)'); grad.addColorStop(1, 'rgba(0,0,0,0.95)');
        ctx.fillStyle = grad;
        ctx.fillRect(game.player.x - 1000, game.player.y - 1000, 2000, 2000);
    }
    ctx.restore();
}

const ui = {
    update: function() {
        document.getElementById('day-display').innerText = `Day ${game.day}`;
        const hour = Math.floor((game.time % 3600) / 150) + 6;
        const realHour = hour % 24;
        document.getElementById('time-display').innerText = `${realHour < 10 ? '0'+realHour : realHour}:00`;
        document.getElementById('threat-display').innerText = game.threat;
        
        // ì²´ë ¥ë°”
        document.getElementById('hp-text').innerText = `${Math.ceil(game.player.hp)}/${game.player.maxHp}`;
        document.getElementById('hp-bar').style.width = `${(game.player.hp/game.player.maxHp)*100}%`;
        
        // í—ˆê¸°ë°”
        document.getElementById('hunger-text').innerText = `${game.player.hunger}/${game.player.maxHunger}`;
        document.getElementById('hunger-bar').style.width = `${(game.player.hunger/game.player.maxHunger)*100}%`;

        document.getElementById('wood-text').innerText = game.player.wood;
        document.getElementById('ammo-text').innerText = game.player.ammo;
    }
}

input.init();
game.initWorld();
function loop() { update(); draw(); requestAnimationFrame(loop); }
loop();

</script>
</body>
</html>
